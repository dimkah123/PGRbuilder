// PGRBuilder Data Bundle
// Combined for performance optimization

// --- character_images.js ---
const CHARACTER_IMAGES = [
    { frame: "2B", file: "Image/Characters/Coating-2B-Generic.webp" },
    { frame: "9S", file: "Image/Characters/Coating-9S-Generic.webp" },
    { frame: "A2", file: "Image/Characters/Coating-A2-Generic.webp" },
    { frame: "Aegis", file: "Image/Characters/Coating-Aegis-Generic.webp" },
    { frame: "Arca", file: "Image/Characters/Coating-Arca-Generic.webp" },
    { frame: "Arclight", file: "Image/Characters/Coating-Arclight-Generic.webp" },
    { frame: "Ardeo", file: "Image/Characters/Coating-Ardeo-Generic.webp" },
    { frame: "Astral", file: "Image/Characters/Coating-Astral-Generic.webp" },
    { frame: "Bastion", file: "Image/Characters/Coating-Bastion-Generic.webp" },
    { frame: "BLACK★ROCK SHOOTER", file: "Image/Characters/Coating-BLACK★ROCK SHOOTER-Generic.webp" },
    { frame: "Brilliance", file: "Image/Characters/Coating-Brilliance-Generic.webp" },
    { frame: "Capriccio", file: "Image/Characters/Coating-Capriccio-Generic.webp" },
    { frame: "Crepuscule", file: "Image/Characters/Coating-Crepuscule-Generic.webp" },
    { frame: "Crimson Abyss", file: "Image/Characters/Coating-Crimson Abyss-Generic.webp" },
    { frame: "Crimson Weave", file: "Image/Characters/Coating-Crimson Weave-Generic.webp" },
    { frame: "Crocotta", file: "Image/Characters/Coating-Crocotta-Generic.webp" },
    { frame: "Daemonissa", file: "Image/Characters/Coating-Daemonissa-Generic.webp" },
    { frame: "Dante", file: "Image/Characters/Coating-Dante-Generic.webp" },
    { frame: "Dawn", file: "Image/Characters/Coating-Dawn-Generic.webp" },
    { frame: "Daybreak", file: "Image/Characters/Coating-Daybreak-Generic.webp" },
    { frame: "Decryptor", file: "Image/Characters/Coating-Decryptor-Generic.webp" },
    { frame: "Echo", file: "Image/Characters/Coating-Echo-Generic.webp" },
    { frame: "Eclipse", file: "Image/Characters/Coating-Eclipse-Generic.webp" },
    { frame: "Ember", file: "Image/Characters/Coating-Ember-Generic.webp" },
    { frame: "Empyrea", file: "Image/Characters/Coating-Empyrea-Generic.webp" },
    { frame: "Entropy", file: "Image/Characters/Coating-Entropy-Generic.webp" },
    { frame: "Epitaph", file: "Image/Characters/Coating-Epitaph-Generic.webp" },
    { frame: "Feral", file: "Image/Characters/Coating-Feral-Generic.webp" },
    { frame: "Flambeau", file: "Image/Characters/Coating-Flambeau-Generic.webp" },
    { frame: "Fulgor", file: "Image/Characters/Coating-Fulgor-Generic.webp" },
    { frame: "Garnet", file: "Image/Characters/Coating-Garnet-Generic.webp" },
    { frame: "Geiravor", file: "Image/Characters/Coating-Geiravor-Generic.webp" },
    { frame: "Glory", file: "Image/Characters/Coating-Glory-Generic.webp" },
    { frame: "Hyperreal", file: "Image/Characters/Coating-Hyperreal-Generic.webp" },
    { frame: "Hypnos", file: "Image/Characters/Coating-Hypnos-Generic.webp" },
    { frame: "Indomitus", file: "Image/Characters/Coating-Indomitus-Generic.webp" },
    { frame: "Kaleido", file: "Image/Characters/Coating-Kaleido-Generic.webp" },
    { frame: "Laurel", file: "Image/Characters/Coating-Laurel-Generic.webp" },
    { frame: "Limpidity", file: "Image/Characters/Coating-Limpidity-Generic.webp" },
    { frame: "Lost Lullaby", file: "Image/Characters/Coating-Lost Lullaby-Generic.webp" },
    { frame: "Lotus", file: "Image/Characters/Coating-Lotus-Generic.webp" },
    { frame: "Lucid Dreamer", file: "Image/Characters/Coating-Lucid Dreamer-Generic.webp" },
    { frame: "Lux", file: "Image/Characters/Coating-Lux-Generic.webp" },
    { frame: "Oblivion", file: "Image/Characters/Coating-Oblivion-Generic.webp" },
    { frame: "Ornate Bell", file: "Image/Characters/Coating-Ornate Bell-Generic.webp" },
    { frame: "Parhelion", file: "Image/Characters/Coating-Parhelion-Generic.webp" },
    { frame: "Pavo", file: "Image/Characters/Coating-Pavo-Generic.webp" },
    { frame: "Pianissimo", file: "Image/Characters/Coating-Pianissimo-Generic.webp" },
    { frame: "Plume", file: "Image/Characters/Coating-Plume-Generic.webp" },
    { frame: "Pulse", file: "Image/Characters/Coating-Pulse-Generic.webp" },
    { frame: "Pyroath", file: "Image/Characters/Coating-Pyroath-Generic.webp" },
    { frame: "Qilin", file: "Image/Characters/Coating-Qilin-Generic.webp" },
    { frame: "Radiant Daybreak", file: "Image/Characters/Coating-Radiant Daybreak-Generic.webp" },
    { frame: "Remote Star", file: "Image/Characters/Coating-Remote Star-Generic.webp" },
    { frame: "Rigor", file: "Image/Characters/Coating-Rigor-Generic.webp" },
    { frame: "Rozen", file: "Image/Characters/Coating-Rozen-Generic.webp" },
    { frame: "Secator", file: "Image/Characters/Coating-Secator-Generic.webp" },
    { frame: "Shukra", file: "Image/Characters/Coating-Shukra-Generic.webp" },
    { frame: "Silverfang", file: "Image/Characters/Coating-Silverfang-Generic.webp" },
    { frame: "Solacetune", file: "Image/Characters/Coating-Solacetune-Generic.webp" },
    { frame: "Spectre", file: "Image/Characters/Coating-Spectre-Generic.webp" },
    { frame: "Startrail", file: "Image/Characters/Coating-Startrail-Generic.webp" },
    { frame: "Stigmata", file: "Image/Characters/Coating-Stigmata-Generic.webp" },
    { frame: "Storm", file: "Image/Characters/Coating-Storm-Generic.webp" },
    { frame: "Tempest", file: "Image/Characters/Coating-Tempest-Generic.webp" },
    { frame: "Tenebrion", file: "Image/Characters/Coating-Tenebrion-Generic.webp" },
    { frame: "Veiled Star", file: "Image/Characters/Coating-Veiled Star-Generic.webp" },
    { frame: "Vergil", file: "Image/Characters/Coating-Vergil-Generic.webp" },
    { frame: "Veritas", file: "Image/Characters/Coating-Veritas-Generic.webp" },
    { frame: "Vitrum", file: "Image/Characters/Coating-Vitrum-Generic.webp" },
    { frame: "XXI", file: "Image/Characters/Coating-XXI-Generic.webp" },
    { frame: "Zitherwoe", file: "Image/Characters/Coating-Zitherwoe-Generic.webp" }
];

// --- element_images.js ---
const ELEMENT_IMAGES = {
    "burn": "Image/Elements/BURN.webp",
    "dark": "Image/Elements/DARK.webp",
    "fire": "Image/Elements/FIRE.webp",
    "freez": "Image/Elements/FREEZ.webp",
    "general": "Image/Elements/GENERAL.webp",
    "ice": "Image/Elements/ICE.webp",
    "light": "Image/Elements/LIGHT.webp",
    "nihl": "Image/Elements/NIHL.webp",
    "phys": "Image/Elements/PHYS.webp",
    "plasma": "Image/Elements/PLASMA.webp",
    "slash": "Image/Elements/SLASH.webp",
    "thunder": "Image/Elements/THUNDER.webp",
    "umbra": "Image/Elements/UMBRA.webp"
};

// --- class_images.js ---
const CLASS_IMAGES = {
    "amplifier": "Image/Classes/Amplifier.webp",
    "annihilator": "Image/Classes/Annihilator.webp",
    "attacker": "Image/Classes/Attacker.webp",
    "observer": "Image/Classes/Observer.webp",
    "support": "Image/Classes/Support.webp",
    "tank": "Image/Classes/Tank.webp",
    "uniframe": "Image/Classes/Uniframe.webp",
    "vanguard": "Image/Classes/Vanguard.webp"
};

// --- weapon_images.js ---
const WEAPON_IMAGES = {
    "akasha keyblade": "Image/Weapons/Akasha Keyblade.webp",
    "alpha omega": "Image/Weapons/Alpha Omega.webp",
    "apollo": "Image/Weapons/Apollo.webp",
    "astraea": "Image/Weapons/Astraea.webp",
    "aurora": "Image/Weapons/Aurora.webp",
    "baji": "Image/Weapons/Baji.webp",
    "benediction": "Image/Weapons/Benediction.webp",
    "berserk fusion": "Image/Weapons/Berserk Fusion.webp",
    "big kamui": "Image/Weapons/Big Kamui.webp",
    "cestus": "Image/Weapons/Cestus.webp",
    "crimson howl": "Image/Weapons/Crimson Howl.webp",
    "cruel oath mod": "Image/Weapons/Cruel Oath Mod.webp",
    "dark falcon": "Image/Weapons/Dark Falcon.webp",
    "darkness": "Image/Weapons/Darkness.webp",
    "deathless flame": "Image/Weapons/Deathless Flame.webp",
    "devil sword dante": "Image/Weapons/Devil Sword Dante.webp",
    "dragon wind": "Image/Weapons/Dragon Wind.webp",
    "dream roamer": "Image/Weapons/Dream Roamer.webp",
    "durendal": "Image/Weapons/Durendal.webp",
    "empyrean wrath": "Image/Weapons/Empyrean Wrath.webp",
    "final arbiter": "Image/Weapons/Final Arbiter.webp",
    "flamewing of dawn": "Image/Weapons/Flamewing of Dawn.webp",
    "fudo myoo": "Image/Weapons/Fudo Myoo.webp",
    "fusion dragon": "Image/Weapons/Fusion Dragon.webp",
    "galatea": "Image/Weapons/Galatea.webp",
    "gungnir": "Image/Weapons/Gungnir.webp",
    "hackerstune": "Image/Weapons/HackersTune.webp",
    "hecate": "Image/Weapons/Hecate.webp",
    "hestia": "Image/Weapons/Hestia.webp",
    "hydro heat": "Image/Weapons/Hydro Heat.webp",
    "illuminare": "Image/Weapons/Illuminare.webp",
    "implosion": "Image/Weapons/Implosion.webp",
    "infinity": "Image/Weapons/Infinity.webp",
    "inverse chimera": "Image/Weapons/Inverse Chimera.webp",
    "inverse shadow": "Image/Weapons/Inverse Shadow.webp",
    "key of tempus gate stokes": "Image/Weapons/Key of Tempus Gate Stokes.webp",
    "lotus berserker": "Image/Weapons/Lotus Berserker.webp",
    "managarm": "Image/Weapons/Managarm.webp",
    "metis": "Image/Weapons/Metis.webp",
    "neon wayfarer": "Image/Weapons/Neon Wayfarer.webp",
    "nightblaze": "Image/Weapons/Nightblaze.webp",
    "orpheus lullaby": "Image/Weapons/Orpheus Lullaby.webp",
    "osseous guillotine": "Image/Weapons/Osseous Guillotine.webp",
    "ozma": "Image/Weapons/Ozma.webp",
    "peacemaker": "Image/Weapons/Peacemaker.webp",
    "perpetuity": "Image/Weapons/Perpetuity.webp",
    "phoenix": "Image/Weapons/Phoenix.webp",
    "prometheus": "Image/Weapons/Prometheus.webp",
    "purple peony": "Image/Weapons/Purple Peony.webp",
    "qinghe": "Image/Weapons/Qinghe.webp",
    "ramiel": "Image/Weapons/Ramiel.webp",
    "reconstruction of law": "Image/Weapons/Reconstruction of Law.webp",
    "renewed dawn": "Image/Weapons/Renewed Dawn.webp",
    "ripplesofthe aloft sea": "Image/Weapons/Ripplesofthe Aloft Sea.webp",
    "sakura": "Image/Weapons/Sakura.webp",
    "sarastro": "Image/Weapons/Sarastro.webp",
    "sariel": "Image/Weapons/Sariel.webp",
    "scale": "Image/Weapons/Scale.webp",
    "scion": "Image/Weapons/Scion.webp",
    "snore": "Image/Weapons/Snore.webp",
    "sorrow of fata morgana": "Image/Weapons/Sorrow of Fata Morgana.webp",
    "soul ripper": "Image/Weapons/Soul Ripper.webp",
    "soundofsilence": "Image/Weapons/SoundofSilence.webp",
    "stelmo": "Image/Weapons/StElmo.webp",
    "starvoyager": "Image/Weapons/StarVoyager.webp",
    "starlightglare": "Image/Weapons/StarlightGlare.webp",
    "thanatos": "Image/Weapons/Thanatos.webp",
    "tonitrus": "Image/Weapons/Tonitrus.webp",
    "type-4o lance": "Image/Weapons/Type-4O Lance.webp",
    "typezero": "Image/Weapons/TypeZero.webp",
    "virtuous contract": "Image/Weapons/Virtuous Contract.webp",
    "waldmeister": "Image/Weapons/Waldmeister.webp",
    "wolffang": "Image/Weapons/WolfFang.webp",
    "yamato": "Image/Weapons/Yamato.webp",
    "zeroscale": "Image/Weapons/ZeroScale.webp",
    "rock cannon": "Image/Weapons/★Rock Cannon.webp"
};

// --- cub_images.js ---
const CUB_IMAGES = {
    "beep-boop": "Image/CUB/Beep-Boop.webp",
    "billie": "Image/CUB/Billie.webp",
    "boreas": "Image/CUB/Boreas.webp",
    "bramble angler": "Image/CUB/Bramble Angler.webp",
    "cavaliere": "Image/CUB/Cavaliere.webp",
    "cetus": "Image/CUB/Cetus.webp",
    "corvus": "Image/CUB/Corvus.webp",
    "dawn chorus": "Image/CUB/Dawn Chorus.webp",
    "diamaton": "Image/CUB/Diamaton.webp",
    "dreamwing": "Image/CUB/Dreamwing.webp",
    "fei lin": "Image/CUB/Fei Lin.webp",
    "frost oath": "Image/CUB/Frost Oath.webp",
    "guardrake": "Image/CUB/Guardrake.webp",
    "hades fangs": "Image/CUB/Hades Fangs.webp",
    "huiyu": "Image/CUB/Huiyu.webp",
    "jet jaeger": "Image/CUB/Jet Jaeger.webp",
    "levvi": "Image/CUB/Levvi.webp",
    "mirageblades": "Image/CUB/MirageBlades.webp",
    "motorbolt": "Image/CUB/Motorbolt.webp",
    "nitor": "Image/CUB/Nitor.webp",
    "noctiluca": "Image/CUB/Noctiluca.webp",
    "punchy": "Image/CUB/Punchy.webp",
    "rainbow": "Image/CUB/Rainbow.webp",
    "scaled rampart": "Image/CUB/Scaled Rampart.webp",
    "shadow wing": "Image/CUB/Shadow Wing.webp",
    "snow waltz": "Image/CUB/Snow Waltz.webp",
    "snowveil": "Image/CUB/Snowveil.webp",
    "toniris": "Image/CUB/Toniris.webp",
    "wrathfang": "Image/CUB/Wrathfang.webp"
};

// --- memory_data.js ---
const MEMORY_NAMES = [
    "Aife",
    "Aline",
    "Alphonse",
    "Barcelo",
    "Bathlon",
    "Boone",
    "Burana",
    "Catherine",
    "Chang Wuzi",
    "Charlotte",
    "Chen Jiyuan",
    "Cleopatra",
    "Condelina",
    "Cottie",
    "Darwin",
    "DaVinci",
    "Derketo",
    "Diesel",
    "Einsteina",
    "Elizabeth",
    "Erwin",
    "Flamel",
    "Fran",
    "Frederick",
    "Gloria",
    "Guinevere",
    "Hanna",
    "Heisen",
    "Heraclitus",
    "Herschell",
    "Hervor",
    "Ike",
    "Jeanne",
    "Ji Boan",
    "Keats",
    "Klenova",
    "Leeuwenhoek",
    "Liston",
    "Mozart",
    "Natasha",
    "Patton",
    "PhilipII",
    "Poincare",
    "Richelieu",
    "Samantha",
    "Seraphine",
    "Shakespeare",
    "Signa",
    "Sothoth",
    "Tifa",
    "Turing",
    "Unimate",
    "Voltaire",
    "Wilde"
];

// --- terminology.js ---
const TERMINOLOGY_DB = {
    "матрица": "Специальная способность, активируемая при уклонении. Замедляет время и позволяет использовать орбы без затрат (или с бонусами).",
    "кор кор": "Пассивная способность персонажа, определяющая его основной стиль игры.",
    "кор": "Пассивная способность персонажа, определяющая его основной стиль игры.",
    "ульта": "Сигнатурная способность (Signature Move), требующая энергии.",
    "свап": "Смена персонажа (QTE).",
    "qte": "Quick Time Event - вызов персонажа из запаса для нанесения урона или поддержки.",
    "орб": "Сфера навыка (Красный, Желтый, Синий).",
    "пинг": "Активация орба.",
    "3-пинг": "Активация трех орбов одного цвета одновременно.",
    "трипл": "Активация трех орбов одного цвета одновременно.",
    "давинчи": "Мемори Da Vinci, позволяющая активировать второе QTE.",
    "дв": "Мемори Da Vinci.",
    "шукра": "Фрейм Shukra (Qu).",
    "старфарер": "Фрейм Starfarer (Nanami).",
    "эмпирей": "Фрейм Empyrea (Liv).",
    "люменанс": "Фрейм Luminance (Liv).",
    "рикап": "Сброс таймеров или кулдаунов.",
    "прок": "Срабатывание эффекта (вероятностное или гарантированное).",
    "iframe": "Invincibility Frame - кадры неуязвимости (например, во время ульты).",
    "айфрейм": "Invincibility Frame - кадры неуязвимости.",
    "бурст": "Нанесение большого количества урона за короткий промежуток времени.",
    "ротация": "Оптимальная последовательность действий для нанесения максимального урона.",
    "стойка": "Режим боя (например, у Chrome: Glory или 2B).",
    "таймстоп": "Остановка таймера (например, в Warzone или PPC) во время анимации ульты."
};

// --- char_database.js ---
const CHAR_DATABASE = [
    {
        name: "Люсия",
        frame: "Лотус",
        enFrame: "Lotus",
        rank: "B",
        element: "Физический",
        class: "Атакующий",
        weapon: "Lotus Berserker"
    },
    {
        name: "Лив",
        frame: "Эклипс",
        enFrame: "Eclipse",
        rank: "B",
        element: "Физический",
        class: "Поддержка",
        weapon: "Type Zero"
    },
    {
        name: "Нанами",
        frame: "Шторм",
        enFrame: "Storm",
        rank: "B",
        element: "Физический",
        class: "Танк",
        weapon: "Inverse - Chimera"
    },
    {
        name: "Люсия",
        frame: "Давн",
        enFrame: "Dawn",
        rank: "A",
        element: "Молния",
        class: "Атакующий",
        weapon: "Inverse - Shadow"
    },
    {
        name: "Лив",
        frame: "Люкс",
        enFrame: "Lux",
        rank: "A",
        element: "Молния",
        class: "Поддержка",
        weapon: "Benediction"
    },
    {
        name: "Ли",
        frame: "Пэйлфаер",
        enFrame: "Palefire",
        rank: "A",
        element: "Огонь",
        class: "Атакующий",
        weapon: "Wolf Fang"
    },
    {
        name: "Ватанабэ",
        frame: "Найтблейд",
        enFrame: "Nightblade",
        rank: "A",
        element: "Физический",
        class: "Атакующий",
        weapon: "Soul Ripper"
    },
    {
        name: "Бьянка",
        frame: "Зеро",
        enFrame: "Zero",
        rank: "A",
        element: "Физический",
        class: "Атакующий",
        weapon: "Ramiel"
    },
    {
        name: "Каренина",
        frame: "Бласт",
        enFrame: "Blast",
        rank: "A",
        element: "Физический",
        class: "Атакующий",
        weapon: "Berserk Fusion"
    },
    {
        name: "Лив",
        frame: "Люменанс",
        enFrame: "Luminance",
        rank: "S",
        element: "Физический",
        class: "Поддержка",
        weapon: "Dragon Wind"
    },
    {
        name: "Ли",
        frame: "Энтропи",
        enFrame: "Entropy",
        rank: "S",
        element: "Физический",
        class: "Атакующий",
        weapon: "Zero Scale"
    },
    {
        name: "Каренина",
        frame: "Эмбер",
        enFrame: "Ember",
        rank: "S",
        element: "Огонь",
        class: "Атакующий",
        weapon: "Fusion Dragon"
    },
    {
        name: "Нанами",
        frame: "Пульс",
        enFrame: "Pulse",
        rank: "S",
        element: "Огонь",
        class: "Танк",
        weapon: "Hydro Heat"
    },
    {
        name: "Камуи",
        frame: "Тенебрион",
        enFrame: "Tenebrion",
        rank: "S",
        element: "Тьма",
        class: "Танк",
        weapon: "Darkness"
    },
    {
        name: "Люсия",
        frame: "Кримзон Абисс",
        enFrame: "Crimson Abyss",
        rank: "S",
        element: "Физический",
        class: "Атакующий",
        weapon: "Sakura"
    },
    {
        name: "Камуи",
        frame: "Бастион",
        enFrame: "Bastion",
        rank: "A",
        element: "Физический",
        class: "Танк",
        weapon: "Big Kamui"
    },
    {
        name: "Ватанабэ",
        frame: "Астрал",
        enFrame: "Astral",
        rank: "A",
        element: "Тьма",
        class: "Атакующий",
        weapon: "Peacemaker"
    },
    {
        name: "Айла",
        frame: "Брилианс",
        enFrame: "Brilliance",
        rank: "A",
        element: "Физический",
        class: "Танк",
        weapon: "Purple Peony"
    },
    {
        name: "Бьянка",
        frame: "Веритас",
        enFrame: "Veritas",
        rank: "S",
        element: "Молния",
        class: "Атакующий",
        weapon: "Tonitrus",
        cub: "Toniris"
    },
    {
        name: "София",
        frame: "Сильверфанг",
        enFrame: "Silverfang",
        rank: "A",
        element: "Огонь",
        class: "Поддержка",
        weapon: "Scion"
    },
    {
        name: "Хром",
        frame: "Арклайт",
        enFrame: "Arclight",
        rank: "A",
        element: "Молния",
        class: "Танк",
        weapon: "St. Elmo"
    },
    {
        name: "Люсия",
        frame: "Плюм",
        enFrame: "Plume",
        rank: "S",
        element: "Лед",
        class: "Атакующий",
        weapon: "Crimson Birch"
    },
    {
        name: "Вера",
        frame: "Розен",
        enFrame: "Rozen",
        rank: "A",
        element: "Тьма",
        class: "Поддержка",
        weapon: "Sariel"
    },
    {
        name: "Каму",
        frame: "Крокотта",
        enFrame: "Crocotta",
        rank: "S",
        element: "Тьма",
        class: "Авангард",
        weapon: "Thanatos"
    },
    {
        name: "Розетта",
        frame: "Ригор",
        enFrame: "Rigor",
        rank: "S",
        element: "Физический",
        class: "Танк",
        weapon: "Gungnir",
        cub: "Frost Oath"
    },
    {
        name: "Чангю",
        frame: "Цилинь",
        enFrame: "Qilin",
        rank: "A",
        element: "Лед",
        class: "Танк",
        weapon: "Baji"
    },
    {
        name: "Цюй​",
        frame: "Паво",
        enFrame: "Pavo",
        rank: "S",
        element: "Физический",
        class: "Авангард",
        weapon: "Qinghe"
    },
    {
        name: "Луна",
        frame: "Лаурель",
        enFrame: "Laurel",
        rank: "S",
        element: "Тьма",
        class: "Атакующий",
        weapon: "Ozma"
    },
    {
        name: "2B",
        frame: "",
        enFrame: "2B",
        rank: "S",
        element: "Физический",
        class: "Атакующий",
        weapon: "Virtuous Contract - Mod"
    },
    {
        name: "9S",
        frame: "",
        enFrame: "9S",
        rank: "S",
        element: "Физический",
        class: "Поддержка",
        weapon: "Cruel Oath - Mod"
    },
    {
        name: "A2",
        frame: "",
        enFrame: "A2",
        rank: "S",
        element: "Физический",
        class: "Танк",
        weapon: "Type-4O Lance - Mod"
    },
    {
        name: "Ваньши",
        frame: "Гипнос",
        enFrame: "Hypnos",
        rank: "A",
        element: "Лед",
        class: "Поддержка",
        weapon: "Scale"
    },
    {
        name: "Селена",
        frame: "Темпест",
        enFrame: "Tempest",
        rank: "S",
        element: "Молния",
        class: "Авангард",
        weapon: "Waldmeister"
    },
    {
        name: "Хром",
        frame: "Глори",
        enFrame: "Glory",
        rank: "S",
        element: "Лед",
        class: "Танк",
        weapon: "Apollo",
        cub: "Boreas"
    },
    {
        name: "21",
        frame: "XXI",
        enFrame: "XXI",
        rank: "A",
        element: "Тьма",
        class: "Танк",
        weapon: "Snore"
    },
    {
        name: "Вера",
        frame: "Гарнет",
        enFrame: "Garnet",
        rank: "S",
        element: "Молния",
        class: "Танк",
        weapon: "Phoenix"
    },
    {
        name: "Роланд",
        frame: "Фламбеа",
        enFrame: "Flambeau",
        rank: "S",
        element: "Огонь",
        class: "Авангард",
        weapon: "Durendal"
    },
    {
        name: "Лив",
        frame: "Эмпирей",
        enFrame: "Empyrea",
        rank: "S",
        element: "Огонь",
        class: "Амплифаер",
        weapon: "Hestia"
    },
    {
        name: "Селена",
        frame: "Каприччио",
        enFrame: "Capriccio",
        rank: "S",
        element: "Тьма",
        class: "Амплифаер",
        weapon: "Sarastro"
    },
    {
        name: "Пулао",
        frame: "Драгонтол",
        enFrame: "Dragontoll",
        rank: "S",
        element: "Физический",
        class: "Авангард",
        weapon: "Infinity"
    },
    {
        name: "Нанами",
        frame: "Старфарер",
        enFrame: "Starfarer",
        rank: "S",
        element: "Огонь",
        class: "Танк",
        weapon: "Implosion",
        cub: "Jet Jaeger"
    },
    {
        name: "Хаикма",
        frame: "",
        enFrame: "Starveil",
        rank: "S",
        element: "Лед",
        class: "Авангард",
        weapon: "Galatea"
    },
    {
        name: "Каренина",
        frame: "Скайр",
        enFrame: "Scire",
        rank: "S",
        element: "Тьма",
        class: "Танк",
        weapon: "Illuminare",
        affix: "Plasma",
        cub: "Moonhopper"
    },
    {
        name: "Ноан",
        frame: "Арка",
        enFrame: "Arca",
        rank: "S",
        element: "Молния",
        class: "Авангард",
        weapon: "Prometheus"
    },
    {
        name: "Бьянка",
        frame: "Стигмата",
        enFrame: "Stigmata",
        rank: "S",
        element: "Физический",
        class: "Атакующий",
        weapon: "Hecate",
        affix: "Slash",
        cub: "Shimmer"
    },
    {
        name: "Бамбината",
        frame: "Витрум",
        enFrame: "Vitrum",
        rank: "A",
        element: "Лед",
        class: "Атакующий",
        weapon: "Tranquil Doll’s Voice"
    },
    {
        name: "Ли",
        frame: "Гиперреал",
        enFrame: "Hyperreal",
        rank: "S",
        element: "Огонь",
        class: "Атакующий",
        weapon: "Key of Tempus Gate - Stokes",
        cub: "Punchy"
    },
    {
        name: "Айла",
        frame: "Калеидо",
        enFrame: "Kaleido",
        rank: "S",
        element: "Лед",
        class: "Амплифаер",
        weapon: "The Starry Voyager",
        cub: "Rainbow"
    },
    {
        name: "Люсия",
        frame: "Кримзон Вейв",
        enFrame: "Crimson Weave",
        rank: "S",
        element: "Молния",
        class: "Атакующий",
        weapon: "Nightblaze",
        affix: "Umbra",
        cub: "Motorbolt"
    },
    {
        name: "Ханьин",
        frame: "Зитервоу",
        enFrame: "Zitherwoe",
        rank: "A",
        element: "Физический",
        class: "Поддержка",
        weapon: "Perpetuity"
    },
    {
        name: "21",
        frame: "Feral",
        enFrame: "Feral",
        rank: "S",
        element: "Молния",
        class: "Амплифаер",
        weapon: "Managarm",
        cub: "Hades Fangs"
    },
    {
        name: "Ноктис",
        frame: "Индормитус",
        enFrame: "Indomitus",
        rank: "A",
        element: "Молния",
        class: "Атакующий",
        weapon: "Crimson Howl"
    },
    {
        name: "Алиса",
        frame: "Эхо",
        enFrame: "Echo",
        rank: "S",
        element: "Физический",
        class: "Амплифаер",
        weapon: "Astraea",
        affix: "Freez",
        cub: "Dawn Chorus"
    },
    {
        name: "Ламия",
        frame: "Лост Лулаби",
        enFrame: "Lost Lullaby",
        rank: "S",
        element: "Тьма",
        class: "Атакующий",
        weapon: "Metis",
        cub: "Cetus"
    },
    {
        name: "Ватанабэ",
        frame: "Эпитаф",
        enFrame: "Epitaph",
        rank: "S",
        element: "Огонь",
        class: "Танк",
        weapon: "Dark Falcon",
        affix: "Umbra",
        cub: "Shadow Wing"
    },
    {
        name: "Цюй",
        frame: "Шукра",
        enFrame: "Shukra",
        rank: "S",
        element: "Лед",
        class: "Атакующий",
        weapon: "Akasha Keyblade",
        cub: "Huiyu"
    },
    {
        name: "Тедди",
        frame: "Декриптор",
        enFrame: "Decryptor",
        rank: "A",
        element: "Тьма",
        class: "Поддержка",
        weapon: "Hacker's Tune"
    },
    {
        name: "Луна",
        frame: "Обливион",
        enFrame: "Oblivion",
        rank: "S",
        element: "Нихил",
        class: "Атакующий",
        weapon: "Reconstruction of Law",
        cub: "Guardrake"
    },
    {
        name: "Бриджит",
        frame: "Ардео",
        enFrame: "Ardeo",
        rank: "A",
        element: "Огонь",
        class: "Танк",
        weapon: "Cestus"
    },
    {
        name: "Ханьин",
        frame: "Соласетюн",
        enFrame: "Solacetune",
        rank: "S",
        element: "Физический",
        class: "Танк",
        weapon: "Dream Roamer",
        affix: "Slash",
        cub: "Dreamwing"
    },
    {
        name: "Ваньши",
        frame: "Лусид Дример",
        enFrame: "Lucid Dreamer",
        rank: "S",
        element: "Лед",
        class: "Танк",
        weapon: "Renewed Dawn",
        affix: "Freez",
        cub: "Snowveil"
    },
    {
        name: "Люсия",
        frame: "Пироат",
        enFrame: "Pyropath",
        rank: "S",
        element: "Огонь",
        class: "Атакующий",
        weapon: "Flamewing of Dawn",
        affix: "Plasma",
        cub: "Corvus"
    },
    {
        name: "Ята",
        frame: "Фулгор",
        enFrame: "Fulgor",
        rank: "A",
        element: "Молния",
        class: "Атакующий",
        weapon: "Fudo Myo-o"
    },
    {
        name: "Нанами",
        frame: "Стартрейл",
        enFrame: "Startrail",
        rank: "S",
        element: "Молния",
        class: "Танк",
        weapon: "Starlight Glare",
        affix: "Burn",
        cub: "Bramble Angler"
    },
    {
        name: "Ишмаэль",
        frame: "Пархелион",
        enFrame: "Parhelion",
        rank: "S",
        element: "Нихил",
        class: "Наблюдатель",
        weapon: "Alpha-Omega",
        affix: "Disruption",
        cub: "Diamaton"
    },
    {
        name: "Лилит",
        frame: "Демонисса",
        enFrame: "Daemonissa",
        rank: "S",
        element: "Тьма",
        class: "Амплифаер",
        weapon: "Sorrow of Fata Morgana",
        affix: "Plasma",
        cub: "Billie"
    },
    {
        name: "Селена",
        frame: "Пианиссимо",
        enFrame: "Pianissimo",
        rank: "S",
        element: "Физический",
        class: "Атакующий",
        weapon: "Orpheus' Lullaby",
        affix: "Freez",
        cub: "Snow Waltz"
    },
    {
        name: "Джетави",
        frame: "Дейбрейкер",
        enFrame: "Daybreak",
        rank: "A",
        element: "Тьма",
        class: "Атакующий",
        weapon: "Final Arbiter"
    },
    {
        name: "Вера",
        frame: "Гейравёр",
        enFrame: "Geiravor",
        rank: "S",
        element: "Огонь",
        class: "Амплифаер",
        weapon: "Deathless Flame",
        affix: "Umbra",
        cub: "Wrathfang"
    },
    {
        name: "Dante",
        frame: "",
        enFrame: "Dante",
        rank: "S",
        element: "Огонь",
        class: "Атакующий",
        weapon: "Devil Sword Dante",
        affix: "Burn",
        cub: "Cavaliere"
    },
    {
        name: "Vergil",
        frame: "",
        enFrame: "Vergil",
        rank: "S",
        element: "Физический",
        class: "Атакующий",
        weapon: "Yamato",
        affix: "Slash",
        cub: "Mirage Blades"
    },
    {
        name: "Бьянка",
        frame: "Крепускул",
        enFrame: "Crepuscule",
        rank: "S",
        element: "Тьма",
        class: "Атакующий",
        weapon: "Aurora",
        affix: "Light",
        cub: "Noctiluca"
    },
    {
        name: "Дискорд",
        frame: "Секатор",
        enFrame: "Secator",
        rank: "A",
        element: "Физический",
        class: "Атакующий",
        weapon: "Osseous Guillotine",
        affix: "Slash"
    },
    {
        name: "Вероника",
        frame: "Аегис",
        enFrame: "Aegis",
        rank: "S",
        element: "Физический",
        class: "Амплифаер",
        weapon: "Empyrean Wrath",
        affix: "Burn",
        cub: "Scaled Rampart"
    },
    {
        name: "Лив",
        frame: "Лимпидити",
        enFrame: "Limpidity",
        rank: "S",
        element: "Молния",
        class: "Атакующий",
        weapon: "Ripples of the Aloft Sea",
        affix: "Umbra",
        cub: "Levvi"
    },
    {
        name: "Тедди",
        frame: "Спектр",
        enFrame: "Spectre",
        rank: "S",
        element: "Лед",
        class: "Амплифаер",
        weapon: "Neon Wayfarer",
        affix: "Light",
        cub: "Beep-Boop"
    },
    {
        name: "BLACK★ROCK",
        frame: "BLACK★ROCK SHOOTER",
        enFrame: "BLACK★ROCK SHOOTER",
        rank: "A",
        element: "Огонь",
        class: "Атакующий",
        weapon: "★Rock Cannon"
    }
];

// ==========================================
// MERGED UTILITY SCRIPTS
// ==========================================

// --- assets.js ---
/**
 * ASSET MAP & LOGIC
 * Central repository for all static asset paths and mapping logic.
 */

// Global Asset Map
const ASSET_MAP = {
    // Memories - Populated dynamically from MEMORY_NAMES

    // Classes (English)
    "attacker": "images/classes/attacker.webp",
    "tank": "images/classes/tank.webp",
    "support": "images/classes/support.webp",
    "vanguard": "images/classes/vanguard.webp",
    "amplifier": "images/classes/amplifier.webp",

    // Classes (Russian Mapping)
    "атакующий": "images/classes/attacker.webp",
    "танк": "images/classes/tank.webp",
    "поддержка": "images/classes/support.webp",
    "авангард": "images/classes/vanguard.webp",
    "амплифаер": "images/classes/amplifier.webp",

    // Elements (English)
    "physical": "images/elements/physical.webp",
    "fire": "images/elements/fire.webp",
    "ice": "images/elements/ice.webp",
    "lightning": "images/elements/lightning.webp",
    "dark": "images/elements/dark.webp",

    // Elements (Russian Mapping)
    "физический": "images/elements/physical.webp",
    "огонь": "images/elements/fire.webp",
    "лед": "images/elements/ice.webp",
    "лёд": "images/elements/ice.webp",
    "молния": "images/elements/lightning.webp",
    "тьма": "images/elements/dark.webp",
    "нихил": "images/elements/dark.webp",

    // CUBs (Pets)
    "toniris": "Image/CUB/Toniris.webp",
    "frost oath": "Image/CUB/Frost Oath.webp",
    "nitor": "Image/CUB/Nitor.webp",
    "boreas": "Image/CUB/Boreas.webp",
    "jet jaeger": "Image/CUB/Jet Jaeger.webp",
    // "moonhopper": "Image/CUB/Moonhopper.webp", 
    // "shimmer": "Image/CUB/Shimmer.webp", 
    "punchy": "Image/CUB/Punchy.webp",
    "rainbow": "Image/CUB/Rainbow.webp",
    "motorbolt": "Image/CUB/Motorbolt.webp",
    "hades fangs": "Image/CUB/Hades Fangs.webp",
    "dawn chorus": "Image/CUB/Dawn Chorus.webp",
    "cetus": "Image/CUB/Cetus.webp",
    "shadow wing": "Image/CUB/Shadow Wing.webp",
    "huiyu": "Image/CUB/Huiyu.webp",
    "guardrake": "Image/CUB/Guardrake.webp",
    "dreamwing": "Image/CUB/Dreamwing.webp",
    "snowveil": "Image/CUB/Snowveil.webp",
    "corvus": "Image/CUB/Corvus.webp",
    "bramble angler": "Image/CUB/Bramble Angler.webp",
    "diamaton": "Image/CUB/Diamaton.webp",
    "billie": "Image/CUB/Billie.webp",
    "snow waltz": "Image/CUB/Snow Waltz.webp",
    "wrathfang": "Image/CUB/Wrathfang.webp",
    "cavaliere": "Image/CUB/Cavaliere.webp",
    "mirage blades": "Image/CUB/MirageBlades.webp",
    "noctiluca": "Image/CUB/Noctiluca.webp",
    "scaled rampart": "Image/CUB/Scaled Rampart.webp",
    "levvi": "Image/CUB/Levvi.webp",
    "beep-boop": "Image/CUB/Beep-Boop.webp",

    // Weapons (Auto-mapped to Image/Weapons/...)
    "lotus berserker": "Image/Weapons/Lotus Berserker.webp",
    "type zero": "Image/Weapons/TypeZero.webp",
    "inverse - chimera": "Image/Weapons/Inverse Chimera.webp",
    "inverse - shadow": "Image/Weapons/Inverse Shadow.webp",
    "benediction": "Image/Weapons/Benediction.webp",
    "wolf fang": "Image/Weapons/WolfFang.webp",
    "soul ripper": "Image/Weapons/Soul Ripper.webp",
    "ramiel": "Image/Weapons/Ramiel.webp",
    "berserk fusion": "Image/Weapons/Berserk Fusion.webp",
    "dragon wind": "Image/Weapons/Dragon Wind.webp",
    "zero scale": "Image/Weapons/ZeroScale.webp",
    "fusion dragon": "Image/Weapons/Fusion Dragon.webp",
    "hydro heat": "Image/Weapons/Hydro Heat.webp",
    "darkness": "Image/Weapons/Darkness.webp",
    "sakura": "Image/Weapons/Sakura.webp",
    "big kamui": "Image/Weapons/Big Kamui.webp",
    "peacemaker": "Image/Weapons/Peacemaker.webp",
    "purple peony": "Image/Weapons/Purple Peony.webp",
    "tonitrus": "Image/Weapons/Tonitrus.webp",
    "scion": "Image/Weapons/Scion.webp",
    "st. elmo": "Image/Weapons/StElmo.webp",
    "crimson birch": "Image/Weapons/Crimson Birch.webp",
    "sariel": "Image/Weapons/Sariel.webp",
    "thanatos": "Image/Weapons/Thanatos.webp",
    "gungnir": "Image/Weapons/Gungnir.webp",
    "baji": "Image/Weapons/Baji.webp",
    "qinghe": "Image/Weapons/Qinghe.webp",
    "ozma": "Image/Weapons/Ozma.webp",
    "virtuous contract - mod": "Image/Weapons/Virtuous Contract.webp",
    "cruel oath - mod": "Image/Weapons/Cruel Oath Mod.webp",
    "type-4o lance - mod": "Image/Weapons/Type-4O Lance.webp",
    "scale": "Image/Weapons/Scale.webp",
    "waldmeister": "Image/Weapons/Waldmeister.webp",
    "apollo": "Image/Weapons/Apollo.webp",
    "snore": "Image/Weapons/Snore.webp",
    "phoenix": "Image/Weapons/Phoenix.webp",
    "durendal": "Image/Weapons/Durendal.webp",
    "hestia": "Image/Weapons/Hestia.webp",
    "sarastro": "Image/Weapons/Sarastro.webp",
    "infinity": "Image/Weapons/Infinity.webp",
    "implosion": "Image/Weapons/Implosion.webp",
    "galatea": "Image/Weapons/Galatea.webp",
    "illuminare": "Image/Weapons/Illuminare.webp",
    "prometheus": "Image/Weapons/Prometheus.webp",
    "hecate": "Image/Weapons/Hecate.webp",
    "tranquil doll’s voice": "Image/Weapons/TranquilDollsVoice.webp",
    "key of tempus gate - stokes": "Image/Weapons/Key of Tempus Gate Stokes.webp",
    "the starry voyager": "Image/Weapons/StarVoyager.webp",
    "nightblaze": "Image/Weapons/Nightblaze.webp",
    "perpetuity": "Image/Weapons/Perpetuity.webp",
    "managarm": "Image/Weapons/Managarm.webp",
    "crimson howl": "Image/Weapons/Crimson Howl.webp",
    "astraea": "Image/Weapons/Astraea.webp",
    "metis": "Image/Weapons/Metis.webp",
    "★rock cannon": "Image/Weapons/★Rock Cannon.webp",
    "rock cannon": "Image/Weapons/★Rock Cannon.webp",
    "dark falcon": "Image/Weapons/Dark Falcon.webp",
    "akasha keyblade": "Image/Weapons/Akasha Keyblade.webp",
    "hacker's tune": "Image/Weapons/HackersTune.webp",
    "reconstruction of law": "Image/Weapons/Reconstruction of Law.webp",
    "cestus": "Image/Weapons/Cestus.webp",
    "dream roamer": "Image/Weapons/Dream Roamer.webp",
    "renewed dawn": "Image/Weapons/Renewed Dawn.webp",
    "flamewing of dawn": "Image/Weapons/Flamewing of Dawn.webp",
    "fudo myo-o": "Image/Weapons/Fudo Myoo.webp",
    "starlight glare": "Image/Weapons/StarlightGlare.webp",
    "alpha-omega": "Image/Weapons/Alpha Omega.webp",
    "sorrow of fata morgana": "Image/Weapons/Sorrow of Fata Morgana.webp",
    "orpheus' lullaby": "Image/Weapons/Orpheus Lullaby.webp",
    "final arbiter": "Image/Weapons/Final Arbiter.webp",
    "deathless flame": "Image/Weapons/Deathless Flame.webp",
    "devil sword dante": "Image/Weapons/Devil Sword Dante.webp",
    "yamato": "Image/Weapons/Yamato.webp",
    "aurora": "Image/Weapons/Aurora.webp",
    "osseous guillotine": "Image/Weapons/Osseous Guillotine.webp",
    "empyrean wrath": "Image/Weapons/Empyrean Wrath.webp",
    "ripples of the aloft sea": "Image/Weapons/Ripplesofthe Aloft Sea.webp",
    "neon wayfarer": "Image/Weapons/Neon Wayfarer.webp",
};

/**
 * Merge scanned images (Elements, Classes, Weapons, CUBs) into the global map.
 * Also handles localization mapping.
 */
function initializeAssets() {
    // 1. Dynamic Extension from CHAR_DATABASE (Weapons)
    if (typeof CHAR_DATABASE !== 'undefined') {
        CHAR_DATABASE.forEach(char => {
            if (char.weapon) {
                const key = char.weapon.toLowerCase();
                if (!ASSET_MAP[key]) {
                    const filename = key.replace(/[^a-z0-9]/g, '_').replace(/_+/g, '_').replace(/^_|_$/g, '') + ".webp";
                    ASSET_MAP[key] = `images/weapons/${filename}`;
                }
            }
        });
    }

    // 2. Dynamic Extension for MEMORIES
    if (typeof MEMORY_NAMES !== 'undefined') {
        MEMORY_NAMES.forEach(mem => {
            const key = mem.toLowerCase();
            // Default to Icon-1
            ASSET_MAP[key] = `Image/Memories/Memory-${mem}-Icon-1.webp`;
        });
    }

    // 3. Merge Externally Loaded Images
    if (typeof ELEMENT_IMAGES !== 'undefined') Object.assign(ASSET_MAP, ELEMENT_IMAGES);
    if (typeof CLASS_IMAGES !== 'undefined') {
        Object.assign(ASSET_MAP, CLASS_IMAGES);

        // Map Russian Keys to Scanned Keys
        if (ASSET_MAP['amplifier']) {
            ASSET_MAP['усилитель'] = ASSET_MAP['amplifier'];
            ASSET_MAP['амплифаер'] = ASSET_MAP['amplifier'];
        }
        if (ASSET_MAP['annihilator']) ASSET_MAP['аннигилятор'] = ASSET_MAP['annihilator'];
        if (ASSET_MAP['attacker']) ASSET_MAP['атакующий'] = ASSET_MAP['attacker'];
        if (ASSET_MAP['observer']) ASSET_MAP['наблюдатель'] = ASSET_MAP['observer'];
        if (ASSET_MAP['support']) ASSET_MAP['поддержка'] = ASSET_MAP['support'];
        if (ASSET_MAP['tank']) ASSET_MAP['танк'] = ASSET_MAP['tank'];
        if (ASSET_MAP['vanguard']) ASSET_MAP['авангард'] = ASSET_MAP['vanguard'];
    }
    if (typeof WEAPON_IMAGES !== 'undefined') Object.assign(ASSET_MAP, WEAPON_IMAGES);
    if (typeof CUB_IMAGES !== 'undefined') Object.assign(ASSET_MAP, CUB_IMAGES);

    // 4. Update Extra Russian Aliases
    if (ASSET_MAP['phys']) ASSET_MAP['physical'] = ASSET_MAP['phys'];
    if (ASSET_MAP['physical']) ASSET_MAP['физический'] = ASSET_MAP['physical'];

    if (ASSET_MAP['fire']) ASSET_MAP['огонь'] = ASSET_MAP['fire'];

    if (ASSET_MAP['ice']) {
        ASSET_MAP['лед'] = ASSET_MAP['ice'];
        ASSET_MAP['лёд'] = ASSET_MAP['ice'];
    }

    if (ASSET_MAP['thunder']) ASSET_MAP['lightning'] = ASSET_MAP['thunder'];
    if (ASSET_MAP['lightning']) ASSET_MAP['молния'] = ASSET_MAP['lightning'];

    if (ASSET_MAP['nihl']) ASSET_MAP['nihil'] = ASSET_MAP['nihl'];
    if (ASSET_MAP['dark']) {
        ASSET_MAP['тьма'] = ASSET_MAP['dark'];
        ASSET_MAP['nihil'] = ASSET_MAP['dark'];
    }

    // Safety check just in case 'nihl' exists but not 'nihil' text
    if (ASSET_MAP['nihl']) ASSET_MAP['нихил'] = ASSET_MAP['nihl'];

    // 5. Generate Sorted Lists for Indexing (URL Optimization)
    // We use window.VAR to export them globally
    window.WEAPON_NAMES = (typeof WEAPON_IMAGES !== 'undefined') ? Object.keys(WEAPON_IMAGES).sort() : [];
    window.CUB_NAMES = (typeof CUB_IMAGES !== 'undefined') ? Object.keys(CUB_IMAGES).sort() : [];
}


// --- url_optimizer.js ---
/**
 * URL OPTIMIZER
 * Logic to compress/decompress state for sharing via URL.
 * Uses lz-string for compression and dictionary mapping for size reduction.
 */

const UrlOptimizer = {
    // Dictionary Helpers
    getMemories() {
        if (typeof MEMORY_NAMES !== 'undefined') {
            return [...MEMORY_NAMES].sort();
        }
        return [];
    },

    getChars() {
        if (typeof CHAR_DATABASE !== 'undefined') {
            return CHAR_DATABASE;
        }
        return [];
    },

    // ------------------------------------------------
    // OPTIMIZE (State -> Minified Object)
    // ------------------------------------------------
    optimize(state) {
        const min = {};
        const mems = this.getMemories();
        const chars = this.getChars();

        // 1. Character & Frame
        // Try to find exact match in DB to send ID instead of strings
        const charIdx = chars.findIndex(c =>
            (c.enFrame && c.enFrame === state.enFrame) ||
            (c.frame === state.frame)
        );

        if (charIdx !== -1) {
            min.cI = charIdx; // Character Index (covers name, frame, enFrame, default class/element)

            // Check if overrides exist
            const dbChar = chars[charIdx];
            if (state.rank !== dbChar.rank) min.r = state.rank;
            if (state.element !== dbChar.element) min.el = state.element;
            if (state.class !== dbChar.class) min.cl = state.class;

            // Weapon/CUB/Affix are often custom
        } else {
            // Fallback to storing raw strings if custom character
            if (state.char) min.c = state.char;
            if (state.frame) min.f = state.frame;
            if (state.enFrame) min.ef = state.enFrame;
            if (state.rank) min.r = state.rank;
            if (state.element) min.el = state.element;
            if (state.class) min.cl = state.class;
        }

        // 2. Equipment
        // Weapon -> Index
        if (state.weapon) {
            const wName = state.weapon.toLowerCase().trim();
            if (typeof WEAPON_NAMES !== 'undefined') {
                const wIdx = WEAPON_NAMES.indexOf(wName);
                min.w = (wIdx !== -1) ? wIdx : state.weapon;
            } else {
                min.w = state.weapon;
            }
        }

        // Affix
        if (state.affix) min.a = state.affix;

        // CUB -> Index
        if (state.cub) {
            const cName = state.cub.toLowerCase().trim();
            if (typeof CUB_NAMES !== 'undefined') {
                const cIdx = CUB_NAMES.indexOf(cName);
                min.cub = (cIdx !== -1) ? cIdx : state.cub;
            } else {
                min.cub = state.cub;
            }
        }

        if (state.posCode) min.p = state.posCode;

        // 3. Builds
        if (state.builds && state.builds.length > 0) {
            min.b = state.builds.map(build => {
                const bMin = {};
                if (build.title) bMin.t = build.title;

                // Memories -> Indices
                if (build.mems && build.mems.some(m => m)) {
                    bMin.m = build.mems.map(mName => {
                        if (!mName) return "";
                        const mIdx = mems.indexOf(mName);
                        return mIdx !== -1 ? mIdx : mName; // Return Index if found, else Name
                    });
                    // Trim trailing empty strings
                    while (bMin.m.length > 0 && bMin.m[bMin.m.length - 1] === "") {
                        bMin.m.pop();
                    }
                }

                // Harmony
                if (build.harm) {
                    const hIdx = mems.indexOf(build.harm);
                    bMin.h = hIdx !== -1 ? hIdx : build.harm;
                }

                // Resonance
                if (build.resTopSlot) bMin.rtS = build.resTopSlot;
                if (build.resTopSkill) bMin.rtK = build.resTopSkill;
                if (build.resBotSlot) bMin.rbS = build.resBotSlot;
                if (build.resBotSkill) bMin.rbK = build.resBotSkill;

                // Description (Strip HTML)
                if (build.desc) {
                    // Simple HTML strip but preserve newlines
                    let clean = build.desc.replace(/<br\s*\/?>/gi, '\n');
                    clean = clean.replace(/<div>/gi, '\n');
                    clean = clean.replace(/<\/div>/gi, '');
                    clean = clean.replace(/<[^>]+>/g, ''); // Strip remaining tags
                    clean = clean.trim();
                    if (clean) bMin.d = clean;
                }

                return bMin;
            });
        }

        return min;
    },

    // ------------------------------------------------
    // RESTORE (Minified Object -> State)
    // ------------------------------------------------
    restore(min) {
        const state = {
            builds: []
        };
        const mems = this.getMemories();
        const chars = this.getChars();

        // 1. Character
        if (min.cI !== undefined && chars[min.cI]) {
            const dbChar = chars[min.cI];
            state.char = dbChar.name;
            state.frame = dbChar.frame;
            state.enFrame = dbChar.enFrame;
            // Defaults
            state.rank = min.r || dbChar.rank;
            state.element = min.el || dbChar.element;
            state.class = min.cl || dbChar.class;
        } else {
            state.char = min.c || "";
            state.frame = min.f || "";
            state.enFrame = min.ef || "";
            state.rank = min.r || "";
            state.element = min.el || "";
            state.class = min.cl || "";
        }

        // 2. Equipment
        if (min.w !== undefined) {
            if (typeof min.w === 'number' && typeof WEAPON_NAMES !== 'undefined') {
                state.weapon = WEAPON_NAMES[min.w] || "";
            } else {
                state.weapon = min.w || "";
            }
        } else {
            state.weapon = "";
        }

        state.affix = min.a || "";

        if (min.cub !== undefined) {
            if (typeof min.cub === 'number' && typeof CUB_NAMES !== 'undefined') {
                state.cub = CUB_NAMES[min.cub] || "";
            } else {
                state.cub = min.cub || "";
            }
        } else {
            state.cub = "";
        }

        state.posCode = min.p || "";

        // 3. Builds
        if (min.b && Array.isArray(min.b)) {
            state.builds = min.b.map(bMin => {
                const build = {
                    title: bMin.t || "",
                    mems: [],
                    harm: "",
                    resTopSlot: bMin.rtS || "",
                    resTopSkill: bMin.rtK || "",
                    resBotSlot: bMin.rbS || "",
                    resBotSkill: bMin.rbK || "",
                    desc: bMin.d || "" // Already plain text
                };

                // Memories
                if (bMin.m && Array.isArray(bMin.m)) {
                    build.mems = bMin.m.map(val => {
                        if (typeof val === 'number') {
                            return mems[val] || "";
                        }
                        return val || "";
                    });
                    // Pad back to 6
                    while (build.mems.length < 6) build.mems.push("");
                } else {
                    build.mems = ["", "", "", "", "", ""];
                }

                // Harmony
                if (bMin.h !== undefined) {
                    if (typeof bMin.h === 'number') {
                        build.harm = mems[bMin.h] || "";
                    } else {
                        build.harm = bMin.h;
                    }
                }

                return build;
            });
        }

        return state;
    },

    // ------------------------------------------------
    // PUBLIC API
    // ------------------------------------------------
    generateLink(state) {
        try {
            const minified = this.optimize(state);
            const json = JSON.stringify(minified);
            const compressed = LZString.compressToEncodedURIComponent(json);

            const url = new URL(window.location.href);
            url.searchParams.delete('data');
            url.searchParams.set('d', compressed);
            return url.toString();
        } catch (e) {
            console.error("Link Generation Error:", e);
            return null;
        }
    },

    parseLink() {
        const params = new URLSearchParams(window.location.search);

        // 1. Try New Format (?d=)
        const compressed = params.get('d');
        if (compressed) {
            try {
                const json = LZString.decompressFromEncodedURIComponent(compressed);
                if (json) {
                    const minified = JSON.parse(json);
                    return this.restore(minified);
                }
            } catch (e) {
                console.error("New Format Load Error:", e);
            }
        }

        // 2. Try Old Format (?data=)
        const oldData = params.get('data');
        if (oldData) {
            try {
                const json = decodeURIComponent(escape(atob(oldData)));
                return JSON.parse(json);
            } catch (e) {
                console.error("Old Format Load Error:", e);
            }
        }

        return null;
    }
};

window.UrlOptimizer = UrlOptimizer;


// --- mongo_api.js ---
/**
 * MONGODB ATLAS DATA API MODULE
 * Handles saving and loading builds from the cloud.
 */

const MONGO_CONFIG = {
    apiKey: "djnyrhkx",
    endpoint: "https://data.mongodb-api.com/app/data-65e9c0249103f902355b46ef/endpoint/data/v1",
    dataSource: "Cluster0",
    database: "pgr_builder",
    collection: "builds"
};

const MongoApi = {
    generateShortId() {
        const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
        let result = '';
        for (let i = 0; i < 6; i++) {
            result += chars.charAt(Math.floor(Math.random() * chars.length));
        }
        return result;
    },

    async saveBuild(buildData) {
        if (!this.checkConfig()) return null;

        const shortId = this.generateShortId();
        const editToken = crypto.randomUUID();

        const compressedData = LZString.compressToEncodedURIComponent(JSON.stringify(buildData));

        const payload = {
            collection: MONGO_CONFIG.collection,
            database: MONGO_CONFIG.database,
            dataSource: MONGO_CONFIG.dataSource,
            document: {
                shortId: shortId,
                editToken: editToken,
                data: compressedData,
                createdAt: new Date().toISOString()
            }
        };

        try {
            const response = await fetch(`${MONGO_CONFIG.endpoint}/action/insertOne`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'api-key': MONGO_CONFIG.apiKey
                },
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                const errText = await response.text();
                throw new Error(`MongoDB Error: ${response.status} ${errText}`);
            }

            const result = await response.json();
            console.log("Save Success:", result);

            this.storeEditToken(shortId, editToken);

            return { shortId, editToken };
        } catch (error) {
            console.error("MongoApi Save Error:", error);
            alert("Ошибка при сохранении в облако: " + error.message);
            throw error;
        }
    },

    async loadBuild(shortId) {
        if (!this.checkConfig()) return null;

        const payload = {
            collection: MONGO_CONFIG.collection,
            database: MONGO_CONFIG.database,
            dataSource: MONGO_CONFIG.dataSource,
            filter: {
                shortId: shortId
            }
        };

        try {
            const response = await fetch(`${MONGO_CONFIG.endpoint}/action/findOne`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'api-key': MONGO_CONFIG.apiKey
                },
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                throw new Error(`MongoDB Load Error: ${response.status}`);
            }

            const result = await response.json();

            if (!result.document) {
                console.warn("Document not found for ID:", shortId);
                return null;
            }

            if (result.document.data) {
                const json = LZString.decompressFromEncodedURIComponent(result.document.data);
                return JSON.parse(json);
            }
            return null;

        } catch (error) {
            console.error("MongoApi Load Error:", error);
            alert("Не удалось загрузить сборку: " + error.message);
            return null;
        }
    },

    async updateBuild(shortId, newData) {
        if (!this.checkConfig()) return false;

        const editToken = this.getEditToken(shortId);
        if (!editToken) {
            alert("Нет прав на редактирование этой сборки (токен не найден). Создайте новую копию.");
            return false;
        }

        const compressedData = LZString.compressToEncodedURIComponent(JSON.stringify(newData));

        const payload = {
            collection: MONGO_CONFIG.collection,
            database: MONGO_CONFIG.database,
            dataSource: MONGO_CONFIG.dataSource,
            filter: {
                shortId: shortId,
                editToken: editToken
            },
            update: {
                "$set": {
                    data: compressedData,
                    updatedAt: new Date().toISOString()
                }
            }
        };

        try {
            const response = await fetch(`${MONGO_CONFIG.endpoint}/action/updateOne`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'api-key': MONGO_CONFIG.apiKey
                },
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                throw new Error(`MongoDB Update Error: ${response.status}`);
            }

            const result = await response.json();

            if (result.matchedCount === 0) {
                alert("Ошибка обновления: Сборка не найдена или неверный токен редактирования.");
                return false;
            }

            console.log("Update Success:", result);
            return true;
        } catch (error) {
            console.error("MongoApi Update Error:", error);
            alert("Ошибка обновления: " + error.message);
            return false;
        }
    },

    checkConfig() {
        if (MONGO_CONFIG.apiKey === "YOUR_API_KEY_HERE") {
            console.warn("API Key MongoDB не настроен! Проверьте js/mongo_api.js");
            return false;
        }
        return true;
    },

    storeEditToken(shortId, token) {
        try {
            const tokens = JSON.parse(localStorage.getItem('pgr_build_tokens') || '{}');
            tokens[shortId] = token;
            localStorage.setItem('pgr_build_tokens', JSON.stringify(tokens));
        } catch (e) {
            console.error("LocalStorage Error:", e);
        }
    },

    getEditToken(shortId) {
        try {
            const tokens = JSON.parse(localStorage.getItem('pgr_build_tokens') || '{}');
            return tokens[shortId];
        } catch (e) {
            return null;
        }
    }
};

window.MongoApi = MongoApi;

